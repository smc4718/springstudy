< 첨부형 게시판 실제 작업 순서 >

1. SQL작성

2. UploadDto 작성
@NoArgsConstructor
@AllArgsConstructor
@Data
@Builder      // 쉬운 생성을 도와주는 빌더패턴
public class UploadDto {
  private int uploadNo;
  private String title;
  private String contents;
  private String createdAt;
  private String modifiedAt;
  private UserDto userDto;    // private int userNo 를 대체함.
}


3. AttachDto 작성
@NoArgsConstructor
@AllArgsConstructor
@Data
@Builder      // 쉬운 생성을 도와주는 빌더패턴
public class AttachDto {
  private int attachNo;
  private String path;
  private String originalFilename;
  private String filesystemName;
  private int downloadCount;
  private int hasThumbnail;
  private int uploadNo;
}


4. mybatis-config.xml 별명 등록
<configuration>
    
  <!-- 설정 -->
  <settings>
    <setting name="mapUnderscoreToCamelCase" value="true"/>
  </settings>
  
  <typeAliases>
    <typeAlias alias="UserDto"         type="com.gdu.myhome.dto.UserDto"/>
    <typeAlias alias="LeaveUserDto"    type="com.gdu.myhome.dto.LeaveUserDto"/>
    <typeAlias alias="InactiveUserDto" type="com.gdu.myhome.dto.InactiveUserDto"/>
    <typeAlias alias="FreeDto"         type="com.gdu.myhome.dto.FreeDto"/>
    <typeAlias alias="BlogDto"         type="com.gdu.myhome.dto.BlogDto"/>
    <typeAlias alias="BlogImageDto"    type="com.gdu.myhome.dto.BlogImageDto"/>
    <typeAlias alias="CommentDto"      type="com.gdu.myhome.dto.CommentDto"/>
    <typeAlias alias="UploadDto"       type="com.gdu.myhome.dto.UploadDto"/>   <- 이거 추가.
    <typeAlias alias="AttachDto"       type="com.gdu.myhome.dto.AttachDto"/>
  </typeAliases>

</configuration>


5. mapper 폴더에 UploadMapper.xml 만들기
<mapper namespace="com.gdu.myhome.dao.UploadMapper">

</mapper>


6. 서비스 인터페이스 와 서비스임플 클래스(서비스인터페이스 추가) 만들기.
서비스임플에 @Service 붙이기.


7. UploadMapper 인터페이스로 만들기.
@RequiredArgsConstructor
@Service
public class UploadServiceImpl implements UploadService {

  private final UploadMapper uploadMapper;  // 매퍼 이용할 용도
  private final MyFileUtils myFileUtils;    // 파일첨부할 용도
  private final MyPageUtils myPageUtils;    // 목록 다룰 용도
  
}


8. UploadController 만들기.
@RequiredArgsConstructor
@Controller
public class UploadController {

  private final UploadService uploadService;  // 컨트롤러가 사용할 서비스
  
}


9. views 폴더에 upload 폴더 만들고 list.jsp 만들기.


10. Thumbnail 만드는 dependency 추가 (메이븐 사이트 : thumbnailator 검색후 첫 번째 항목)
<!-- 썸네일 자동 생성 -->
<!-- https://mvnrepository.com/artifact/net.coobird/thumbnailator -->
<dependency>
    <groupId>net.coobird</groupId>
    <artifactId>thumbnailator</artifactId>
    <version>0.4.20</version>
</dependency>



10. 13장(file)에 index.jsp 복사해서 15장에 upload 폴더에 write.jsp로 이름변경하여 붙여넣기



11.. write.jsp 작성
-----------------------------------------------------------
<jsp:include page="../layout/header.jsp">
  <jsp:param value="업로드게시글작성" name="title"/>
</jsp:include>

<div>

  <h1 style="text-align: center;">Upload 게시글 작성하기</h1>
  
  <form method="post" action="${contextPath}/upload/add.do" enctype="multipart/form-data">
    <div>
      <label for="email" class="form-label">작성자</label>
      <input type="text" id="email" class="form-control-plaintext" value="${sessionScope.user.email}" readonly>
    </div>
    <div>
      <label for="title" class="form-label">제목</label>
      <input type="text" name="title" id="title" class="form-control">
    </div>
    <div>
      <label for="contents" class="form-label">내용</label>
      <textarea rows="3" name="contents" id="contents" class="form-control"></textarea>
    </div>
    <div>
      <label for="files" class="form-label">첨부</label>
      <input type="file" name="files" id="files" class="form-control" multiple>
    </div>
    <div class="d-grid gap-2 col-6 mx-auto">
      <input type="hidden" name="userNo" value="${sessionScope.user.userNo}">
      <button type="submit" class="btn btn-primary" style="margin: 32px;">작성완료</button>
    </div>
  </form>
  
  <div id="file_list"></div>
  
</div>
  
<script>

  const fnFileCheck = () => {
    $('#files').change((ev) => {
      $('#file_list').empty();
      let maxSize = 1024 * 1024 * 100;
      let maxSizePerFile = 1024 * 1024 * 10;
      let totalSize = 0;
      let files = ev.target.files;
      for(let i = 0; i < files.length; i++){
        totalSize += files[i].size;
        if(files[i].size > maxSizePerFile){
          alert('각 첨부파일의 최대 크기는 10MB입니다.');
          $(ev.target).val('');
          $('#file_list').empty();
          return;
        }
        $('#file_list').append('<div>' + files[i].name + '</div>');
      }
      if(totalSize > maxSize){
        alert('전체 첨부파일의 최대 크기는 100MB입니다.');
        $(ev.target).val('');
        $('#file_list').empty();
        return;
      }
    })
  }
  
  fnFileCheck();
  
</script>
  
<%@ include file="../layout/footer.jsp" %>
----------------------------------------------


12. list.jsp 작성
-------------------------------------------------------
<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<%@ taglib uri="http://java.sun.com/jsp/jstl/fmt" prefix="fmt" %>
<%@ taglib uri="http://java.sun.com/jsp/jstl/functions" prefix="fn" %>
<c:set var="contextPath" value="${pageContext.request.contextPath}" />
<c:set var="dt" value="<%=System.currentTimeMillis()%>" />

<jsp:include page="../layout/header.jsp">
  <jsp:param value="업로드게시판" name="title"/>
</jsp:include>

<div>

  <div>
    <a href="${contextPath}/upload/write.form">
      <button type="button" class="btn btn-primary">새글작성</button>
    </a>
  </div>
  
  <div id="upload_list"></div>

</div>

<script>

</script>

<%@ include file="../layout/footer.jsp" %>
---------------------------------------------------


13. 컨트롤러 추가 작성
@RequestMapping("/upload")  // /upload 로 시작하는 것들은 다 컨트롤러로 온다.
@RequiredArgsConstructor
@Controller
public class UploadController {

  private final UploadService uploadService;  // 컨트롤러가 사용할 서비스
  
  @GetMapping("/list.do")
  public String list() {
    return "upload/list";
  }
  
  @GetMapping("/write.form")
  public String write() {
    return "upload/write";
  }
}



14. layout 폴더에 header.jsp 에 추가 작성
<li><a href="${contextPath}/upload/list.do">첨부게시판</a></li>


15. servlet-context.xml 에 추가 작성
<mapping path="/upload/write.form"/>



16. 매퍼.xml 작성
<insert id="insertUpload" parameterType="UploadDto">
    INSERT INTO UPLOAD_T (
        UPLOAD_NO
      , TITLE
      , CONTENTS
      , USER_NO
      , CREATED_AT
      , MODIFIED_AT
    ) VALUES (
        UPLOAD_SEQ.NEXTVAL
      , #{title}
      , #{contents}
      , #{userDto.userNo}
      , TO_CHAR(SYSDATE, 'YYYY-MM-DD HH24:MI:SS') 
      , TO_CHAR(SYSDATE, 'YYYY-MM-DD HH24:MI:SS') 
    )
  </insert>

  <insert id="insertAttach" parameterType="AttachDto">
    INSERT INTO ATTACH_T (
        ATTACH_NO
      , PATH
      , ORIGINAL_FILENAME
      , FILESYSTEM_NAME
      , DOWNLOAD_COUNT
      , HAS_THUMBNAIL
      , UPLOAD_NO
    ) VALUES (
        ATTACH_SEQ.NEXTVAL
      , #{path}
      , #{originalFilename}
      , #{filesystemName}
      , 0
      , #{hasThumbnail}
      , #{uploadNo}
    )
    
  </insert>
  

  
17. 매퍼.java 작성
@Mapper
public interface UploadMapper {
  public int insertUpload(UploadDto upload);
  public int insertAttach(AttachDto attach);
}


18. 서비스 작성
public interface UploadService {
  public int addUpload(MultipartHttpServletRequest request); // 파일첨부때문에 일반HttpServletRequest는 사용 못한다.
}


19. 서비스임플 작성
------------------------------------------
  @Override
  public int addUpload(MultipartHttpServletRequest multipartRequest) throws Exception {
    
    String title = multipartRequest.getParameter("title");
    String contents = multipartRequest.getParameter("contents");
    int userNo = Integer.parseInt(multipartRequest.getParameter("userNo"));
    
    UploadDto upload = UploadDto.builder()
                        .title(title)
                        .contents(contents)
                        .userDto(UserDto.builder()
                                  .userNo(userNo)
                                  .build())
                        .build();
                        
    int addUploadResult = uploadMapper.insertUpload(upload);
    
    List<MultipartFile> files = multipartRequest.getFiles("files");     //첨부된 파일을 'MultipartFile' 이라고 부른다. multiple은 첨부파일이 여러개이기 때문에 List로 잡아야 한다.
    
    for(MultipartFile multipartFile : files) {
      if(multipartFile != null && !multipartFile.isEmpty()) {
        
        String path = myFileUtils.getUploadPath();
        File dir = new File(path);
        if(!dir.exists()) {
          dir.mkdirs();
        }
        
        String originalFilename = multipartFile.getOriginalFilename();
        String filesystemName = myFileUtils.getFilesystemName(originalFilename);  // 원래 이름에 확장자를 그대로 사용하기 위해 전달해주는 작업이 필요함.
        File file = new File(dir, filesystemName);
        
        multipartFile.transferTo(file);
        
      }
    }
    return 0;
  }
------------------------------------------------------


20. MyFileUtils.java 추가 작성.
  // 업로드 게시판 작성시 첨부한 파일이 저장될 경로 반환하기
  public String getUploadPath() {
    LocalDate today = LocalDate.now();
    return "/upload/" + DateTimeFormatter.ofPattern("yyyy/MM/dd").format(today);
  }
  
  
  

21.서비스 수정
public interface UploadService {
  public int addUpload(MultipartHttpServletRequest request) throws Exception; // 파일첨부때문에 일반HttpServletRequest는 사용 못한다.
}




21. 컨트롤러 작성
  @PostMapping("/add.do")
  public String add(MultipartHttpServletRequest multipartRequest
                  , RedirectAttributes redirectAttributes) throws Exception {
    int addResult = uploadService.addUpload(multipartRequest);
    redirectAttributes.addFlashAttribute("addResult", addResult);
    return "redirect:/upload/list.do";
  }

  
  
22. 매퍼.xml 에 추가 작성 및 수정
  <insert id="insertUpload" parameterType="UploadDto">
    <!-- insert를 수행하기 전에 시퀀스 값을 파라미터 UploadDto의 uploadNo 필드에 UPLOAD_SEQ.NEXTVAL값을 저장한다. -->
    <selectKey order="BEFORE" resultType="int" keyProperty="uploadNo">
      SELECT UPLOAD_SEQ.NEXTVAL
        FROM DUAL
    </selectKey>
    INSERT INTO UPLOAD_T (
        UPLOAD_NO
      , TITLE
      , CONTENTS
      , USER_NO
      , CREATED_AT
      , MODIFIED_AT
    ) VALUES (
        #{uploadNo}
      , #{title}
      , #{contents}
      , #{userDto.userNo}
      , TO_CHAR(SYSDATE, 'YYYY-MM-DD HH24:MI:SS') 
      , TO_CHAR(SYSDATE, 'YYYY-MM-DD HH24:MI:SS') 
    )
  </insert>
  
====================================================================



[ 썸네일 만드는 코드와 썸네일있는지 여부 확인 ]


1. UploadServiceImpl (addUpload 메소드 안에 추가 작성)
----------------------------------------------------------
  @Override
  public boolean addUpload(MultipartHttpServletRequest multipartRequest) throws Exception {
    
    String title = multipartRequest.getParameter("title");
    String contents = multipartRequest.getParameter("contents");
    int userNo = Integer.parseInt(multipartRequest.getParameter("userNo"));
    
    UploadDto upload = UploadDto.builder()
                        .title(title)
                        .contents(contents)
                        .userDto(UserDto.builder()
                                  .userNo(userNo)
                                  .build())
                        .build();
                        
    int uploadCount = uploadMapper.insertUpload(upload);
    
    List<MultipartFile> files = multipartRequest.getFiles("files");     //첨부된 파일을 'MultipartFile' 이라고 부른다. multiple은 첨부파일이 여러개이기 때문에 List로 잡아야 한다.
    
    // 첨부 없을 때 : [MultipartFile[field="files", filename=, contentType=application/octet-stream, size=0]]
    // 첨부 1개 : [MultipartFile[field="files", filename="animal1.jpg", contentType=image.jpg size=0]]
    
    int attachCount;
    if(files.get(0).getSize() == 0) {   // 첨부가 없었으면,
      attachCount = 1;
    } else {
      attachCount = 0;
    }
    
    for(MultipartFile multipartFile : files) {
      
      if(multipartFile != null && !multipartFile.isEmpty()) {
        
        String path = myFileUtils.getUploadPath();
        File dir = new File(path);
        if(!dir.exists()) {
          dir.mkdirs();
        }
        
        String originalFilename = multipartFile.getOriginalFilename();
        String filesystemName = myFileUtils.getFilesystemName(originalFilename);  // 원래 이름에 확장자를 그대로 사용하기 위해 전달해주는 작업이 필요함.
        File file = new File(dir, filesystemName);
        
        multipartFile.transferTo(file);
        
        String contentType = Files.probeContentType(file.toPath()); // 이미지의 Content-Type : image/jpeg, image/png 등 image로 시작한다.
        int hasThumbnail = (contentType != null && contentType.startsWith("image")) ? 1 : 0; // null 체크가 필요하면 반드시 앞에 먼저 작성해준다.(contentType != null 가 이 구문과 같이 앞에 먼저 작성되어 있어야 한다는말)
        
        if(hasThumbnail == 1) {
          File thumbnail = new File(dir, "s_" + filesystemName); // small 이미지를 의미하는 s_을 덧붙임.
          Thumbnails.of(file)
                    .size(100,  100)
                    .toFile(thumbnail);
        }
      
        AttachDto attach = AttachDto.builder()
                             .path(path)
                             .originalFilename(originalFilename)
                             .filesystemName(filesystemName)
                             .hasThumbnail(hasThumbnail)
                             .uploadNo(userNo)
                             .build();
        
        attachCount += uploadMapper.insertAttach(attach);
        
      }  // if
      
    }    // for
    
    return (uploadCount == 1) && (files.size() == attachCount);   // 1이면 성공. attachCount와 파일사이즈가 같으면 성공. 
    
  }
-----------------------------------------------------------------


2. 서비스 수정 (타입을 boolean으로 수정)
public interface UploadService {
  public boolean addUpload(MultipartHttpServletRequest request) throws Exception; // 파일첨부때문에 일반HttpServletRequest는 사용 못한다.
}



3. 컨트롤러 수정
  @PostMapping("/add.do")
  public String add(MultipartHttpServletRequest multipartRequest
                  , RedirectAttributes redirectAttributes) throws Exception {
    boolean addResult = uploadService.addUpload(multipartRequest);
    redirectAttributes.addFlashAttribute("addResult", addResult);
    return "redirect:/upload/list.do";
  }
  


4. list.jsp 작성
<script>

	const fnAddResult = () => {
	  let addResult = '${addResult}';	// '', 'true', 'false'
	  if(addResult != ''){
		 if(addResult === 'true'){
			alert('성공적으로 업로드 되었습니다.');
			// 목록 갱신이 들어와야 하는 자리
		 } else {
		   alert('업로드가 실패하였습니다.');
		 }
	  }
	  
	}
	
	// 호출
	fnAddResult();

</script>






















